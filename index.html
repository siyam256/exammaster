<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Master Secure</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f1f5f9; }
        .loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Editor Styles */
        .rich-editor { min-height: 80px; background: white; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; outline: none; }
        .rich-editor:focus { border-color: #6366f1; ring: 2px; }
    </style>
</head>
<body>

    <!-- 1. LOGIN UI -->
    <div id="auth-layer" class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm border border-slate-200">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-slate-800">Exam Master</h1>
                <p class="text-xs text-slate-500">অ্যাডমিন প্যানেল</p>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" class="w-full p-3 border rounded-lg text-sm" placeholder="ইমেইল" required>
                <input type="password" id="pass" class="w-full p-3 border rounded-lg text-sm" placeholder="পাসওয়ার্ড" required>
                <div id="login-error" class="text-red-500 text-xs text-center font-bold min-h-[1rem]"></div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 flex justify-center gap-2 items-center">
                    <span id="btn-text">লগইন</span> <span id="btn-loader" class="loader hidden"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- 2. REACT ROOT (Hidden initially) -->
    <div id="root" class="hidden h-screen w-screen overflow-hidden flex flex-col"></div>

    <!-- 3. FIREBASE SETUP & AUTH LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ============================================================
        // ⚠️ কনফিগ এবং অ্যাডমিন ইমেইল নিচে বসান ⚠️
        // ============================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyA2xWBB8x0qVXyekmmKv4LzBISoAiPb8S0",
            authDomain: "exammaster-91462.firebaseapp.com",
            projectId: "exammaster-91462",
            storageBucket: "exammaster-91462.firebasestorage.app",
            messagingSenderId: "271514723562",
            appId: "1:271514723562:web:0dac5aeb1dfcfb061b2393",
            measurementId: "G-DDWGB954KH"
        };

        // ⚠️ এখানে সেই ইমেইল দিন যা দিয়ে আপনি Firebase Console এ User বানিয়েছেন
        const SUPER_ADMIN_EMAIL = "apnar_email@gmail.com"; 

        // ============================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to Global Window for React
        window.db = db;
        window.auth = auth;
        window.SUPER_ADMIN_EMAIL = SUPER_ADMIN_EMAIL;
        window.functions = { signOut, setDoc, doc, collection, getDocs, deleteDoc, getDoc };

        // Handle Auth State
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Check if user is Super Admin OR in allowed list
                let isAllowed = false;
                
                if (user.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase()) {
                    isAllowed = true;
                } else {
                    // Check database for other users
                    try {
                        const userDoc = await getDoc(doc(db, "allowed_users", user.email));
                        if (userDoc.exists()) isAllowed = true;
                    } catch (err) {
                        console.error("DB Check Failed:", err);
                    }
                }

                if (isAllowed) {
                    document.getElementById('auth-layer').classList.add('hidden');
                    document.getElementById('root').classList.remove('hidden');
                    loadReactApp(user);
                } else {
                    alert("আপনার অ্যাক্সেস নেই! অ্যাডমিনের সাথে যোগাযোগ করুন।");
                    signOut(auth);
                }
            } else {
                document.getElementById('auth-layer').classList.remove('hidden');
                document.getElementById('root').classList.add('hidden');
            }
        });

        // Handle Login Form
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            const errDiv = document.getElementById('login-error');
            const loader = document.getElementById('btn-loader');
            const btnText = document.getElementById('btn-text');

            errDiv.innerText = "";
            loader.classList.remove('hidden');
            btnText.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                // Success is handled by onAuthStateChanged
            } catch (error) {
                console.error(error);
                let msg = "লগইন ব্যর্থ হয়েছে";
                if(error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    msg = "ইমেইল বা পাসওয়ার্ড ভুল";
                } else if (error.code === 'auth/too-many-requests') {
                    msg = "বেশিবার ভুল করায় ব্লক করা হয়েছে। পরে চেষ্টা করুন।";
                }
                errDiv.innerText = msg;
                loader.classList.add('hidden');
                btnText.classList.remove('hidden');
            }
        });

        function loadReactApp(user) {
            window.currentUser = user;
            if (!window.reactLoaded) {
                const scriptContent = document.getElementById('protected-react-code').textContent;
                const script = document.createElement('script');
                script.type = 'text/babel';
                script.textContent = scriptContent;
                document.body.appendChild(script);
                window.reactLoaded = true;
            }
        }
    </script>

    <!-- 4. MAIN APPLICATION LOGIC (লগইন না করলে ব্রাউজার এটি পড়বে না) -->
    <script type="text/plain" id="protected-react-code">
        const { useState, useEffect, useRef } = React;
        const { signOut, setDoc, doc, collection, getDocs, deleteDoc } = window.functions;

        // --- Icons Helper ---
        const Icon = ({ name, size=18, className="" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{width: size, height: size}} className={className}></i>;
        };

        // --- Admin Panel ---
        const AdminPanel = ({ onClose }) => {
            const [users, setUsers] = useState([]);
            const [newUser, setNewUser] = useState("");
            const [loading, setLoading] = useState(false);

            const fetchUsers = async () => {
                try {
                    const snap = await getDocs(collection(window.db, "allowed_users"));
                    setUsers(snap.docs.map(d => d.data()));
                } catch(e) { console.error(e); }
            };

            useEffect(() => { fetchUsers(); }, []);

            const handleAdd = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await setDoc(doc(window.db, "allowed_users", newUser), { email: newUser, addedAt: new Date().toISOString() });
                    setNewUser("");
                    fetchUsers();
                    alert("ইউজার লিস্টে অ্যাড হয়েছে। এখন Firebase Console থেকে এই ইমেইল দিয়ে Authentication এ ইউজার তৈরি করুন।");
                } catch(e) { alert("Error: " + e.message); }
                setLoading(false);
            };

            const handleDelete = async (email) => {
                if(!confirm("নিশ্চিত?")) return;
                await deleteDoc(doc(window.db, "allowed_users", email));
                fetchUsers();
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg w-full max-w-md p-4 shadow-xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="font-bold">ইউজার ম্যানেজমেন্ট</h3>
                            <button onClick={onClose} className="text-red-500 font-bold">X</button>
                        </div>
                        <form onSubmit={handleAdd} className="flex gap-2 mb-4">
                            <input value={newUser} onChange={e=>setNewUser(e.target.value)} type="email" placeholder="নতুন ইমেইল" className="border p-2 rounded flex-1 text-sm" required/>
                            <button disabled={loading} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">অ্যাড</button>
                        </form>
                        <div className="bg-slate-50 p-2 rounded h-40 overflow-y-auto space-y-1">
                            {users.map(u => (
                                <div key={u.email} className="flex justify-between items-center bg-white p-2 border rounded text-xs">
                                    <span>{u.email}</span>
                                    <button onClick={()=>handleDelete(u.email)} className="text-red-500 hover:underline">ডিলিট</button>
                                </div>
                            ))}
                            {users.length===0 && <p className="text-center text-gray-400">লিস্ট খালি</p>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Editor Component ---
        const Editor = ({ value, onChange, placeholder, minH="80px" }) => {
            const ref = useRef(null);
            const exec = (cmd, val=null) => {
                document.execCommand(cmd, false, val);
                ref.current.focus();
            };
            
            return (
                <div className="border rounded-lg bg-white overflow-hidden focus-within:ring-1 ring-indigo-500 border-slate-300">
                    <div className="bg-slate-100 p-1 flex gap-1 border-b overflow-x-auto" onMouseDown={e=>e.preventDefault()}>
                        {['bold','italic','underline'].map(c => (
                            <button key={c} onClick={()=>exec(c)} className="p-1 px-2 hover:bg-white rounded border border-transparent hover:border-slate-300 font-bold capitalize text-xs">{c[0]}</button>
                        ))}
                        <button onClick={()=>exec('superscript')} className="p-1 px-2 hover:bg-white rounded text-xs">x²</button>
                        <button onClick={()=>exec('subscript')} className="p-1 px-2 hover:bg-white rounded text-xs">x₂</button>
                    </div>
                    <div 
                        ref={ref}
                        className="rich-editor p-2 text-sm"
                        style={{minHeight: minH}}
                        contentEditable
                        onInput={e => onChange(e.currentTarget.innerHTML)}
                        dangerouslySetInnerHTML={{__html: value}}
                        placeholder={placeholder}
                    />
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [showAdmin, setShowAdmin] = useState(false);
            const [questions, setQuestions] = useState([]);
            const [form, setForm] = useState({ id: null, text: '', options: {A:'',B:'',C:'',D:''}, correct: 'A', exp: '' });

            const addQ = () => {
                const newQ = { ...form, id: form.id || Date.now() };
                if(form.id) setQuestions(questions.map(q => q.id === form.id ? newQ : q));
                else setQuestions([...questions, newQ]);
                setForm({ id: null, text: '', options: {A:'',B:'',C:'',D:''}, correct: 'A', exp: '' });
                alert(form.id ? "আপডেট হয়েছে" : "যুক্ত হয়েছে");
            };

            const editQ = (q) => {
                setForm(q);
                // Simple scroll to top
                window.scrollTo({top:0, behavior:'smooth'});
            };

            return (
                <div className="flex flex-col h-full">
                    {/* Header */}
                    <div className="bg-white border-b p-3 flex justify-between items-center shadow-sm shrink-0 z-40">
                        <div className="flex items-center gap-2">
                            <span className="bg-indigo-600 text-white p-1 rounded"><Icon name="layout" /></span>
                            <h1 className="font-bold text-slate-800">Exam Master</h1>
                        </div>
                        <div className="flex gap-2 text-xs">
                            {window.currentUser.email === window.SUPER_ADMIN_EMAIL && 
                                <button onClick={()=>setShowAdmin(true)} className="bg-slate-800 text-white px-3 py-1.5 rounded font-bold">ইউজার</button>
                            }
                            <button onClick={()=>signOut(window.auth)} className="bg-rose-500 text-white px-3 py-1.5 rounded font-bold">লগআউট</button>
                        </div>
                    </div>

                    {showAdmin && <AdminPanel onClose={()=>setShowAdmin(false)} />}

                    <div className="flex-1 overflow-auto p-4 md:flex gap-4">
                        {/* Editor Section */}
                        <div className="w-full md:w-1/2 bg-white p-4 rounded-xl shadow-sm border space-y-4 mb-4 md:mb-0">
                            <h2 className="font-bold text-slate-600 border-b pb-2">এডিটর প্যানেল</h2>
                            
                            <div>
                                <label className="text-xs font-bold text-slate-500">প্রশ্ন</label>
                                <Editor value={form.text} onChange={v=>setForm({...form, text:v})} />
                            </div>

                            <div className="space-y-2">
                                {['A','B','C','D'].map(opt => (
                                    <div key={opt} className="flex gap-2">
                                        <div className="w-6 h-6 flex items-center justify-center bg-slate-100 rounded border font-bold text-xs mt-1">{opt}</div>
                                        <div className="flex-1">
                                            <Editor minH="40px" value={form.options[opt]} onChange={v=>setForm({...form, options: {...form.options, [opt]: v}})} />
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="flex gap-2">
                                <select value={form.correct} onChange={e=>setForm({...form, correct: e.target.value})} className="border p-2 rounded bg-slate-50 font-bold text-indigo-600 w-full">
                                    {['A','B','C','D'].map(o=><option key={o} value={o}>সঠিক উত্তর: {o}</option>)}
                                </select>
                            </div>

                            <button onClick={addQ} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-indigo-700 flex justify-center items-center gap-2">
                                <Icon name={form.id ? "save" : "plus-circle"} /> {form.id ? "সেভ করুন" : "যুক্ত করুন"}
                            </button>
                        </div>

                        {/* List/Preview Section */}
                        <div className="w-full md:w-1/2 bg-slate-200 p-4 rounded-xl overflow-y-auto">
                            <h2 className="font-bold text-slate-600 mb-3">তৈরি করা প্রশ্ন ({questions.length})</h2>
                            <div className="space-y-3">
                                {questions.map((q, i) => (
                                    <div key={q.id} className="bg-white p-3 rounded-lg shadow-sm border relative group">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="bg-slate-800 text-white w-5 h-5 flex items-center justify-center rounded text-xs font-bold">{i+1}</span>
                                            <div className="flex gap-2">
                                                <button onClick={()=>editQ(q)} className="text-indigo-600 bg-indigo-50 p-1 rounded"><Icon name="edit-2" size={14}/></button>
                                                <button onClick={()=>{if(confirm('মুছবেন?')) setQuestions(questions.filter(x=>x.id!==q.id))}} className="text-rose-600 bg-rose-50 p-1 rounded"><Icon name="trash" size={14}/></button>
                                            </div>
                                        </div>
                                        <div className="text-sm font-medium mb-1" dangerouslySetInnerHTML={{__html: q.text}}></div>
                                        <div className="grid grid-cols-2 gap-2 text-xs text-slate-600">
                                            {Object.entries(q.options).map(([k,v]) => (
                                                <div key={k} className="flex gap-1">
                                                    <b>{k}.</b> <span dangerouslySetInnerHTML={{__html: v}}></span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="mt-2 text-xs font-bold text-green-600">সঠিক: {q.correct}</div>
                                    </div>
                                ))}
                                {questions.length === 0 && <div className="text-center text-slate-400 py-10">কোনো প্রশ্ন নেই</div>}
                            </div>
                            
                            {/* Final Preview Button */}
                            {questions.length > 0 && (
                                <button onClick={()=>window.print()} className="mt-4 w-full bg-slate-800 text-white py-2 rounded font-bold shadow-lg">প্রিন্ট / প্রিভিউ</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
```

### এটি কাজ করানোর জন্য যা যা অবশ্যই করতে হবে:

১. **ইমেইল বসানো:**
   কোডের `const SUPER_ADMIN_EMAIL = "apnar_email@gmail.com";` লাইনে আপনার যে ইমেইল দিয়ে Firebase Authentication এ একাউন্ট খোলা আছে, ঠিক সেই ইমেইলটি বসান। অন্যথায় `Access Denied` দেখাবে।

২. **Firebase Rules আপডেট করা (নিরাপত্তার জন্য):**
   আপনার কনফিগ পাবলিক থাকলেও ডাটাবেস নিরাপদ রাখতে Firebase Console এ গিয়ে **Firestore Database > Rules** ট্যাবে যান এবং নিচের কোডটি পেস্ট করে `Publish` করুন:

   ```javascript
   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {
       match /allowed_users/{document=**} {
         // শুধুমাত্র অথেনটিকেটেড ইউজাররা পড়তে পারবে
         allow read: if request.auth != null;
         // শুধুমাত্র সুপার অ্যাডমিন লিখতে পারবে (নিচের ইমেইলটি আপনার ইমেইল দিয়ে বদলান)
         allow write: if request.auth.token.email == 'apnar_email@gmail.com'; 
       }
     }
   }
